<ion-header>
  <ion-toolbar>
    <ion-title>{{ 'EDITOR.SHELL.TITLE' | translate }}</ion-title>

    @if (showSessionActions()) {
      <ion-buttons slot="end">
        <ion-button (click)="cancel()">{{ 'EDITOR.SHELL.BUTTON.CANCEL' | translate }}</ion-button>
        <ion-button [disabled]="!ready" (click)="done()">{{ 'EDITOR.SHELL.BUTTON.DONE' | translate }}</ion-button>
      </ion-buttons>
    }
  </ion-toolbar>

  <ion-toolbar class="top-toolbox">
    <div class="top-toolbox__row">
      <div class="top-toolbox__center">
        <ion-button fill="clear" class="tool-btn" [disabled]="!history.canUndo()" (click)="undo()">
          <div class="app-icon-text">
            <ion-icon class="app-icon-text__icon" name="return-up-back-outline"></ion-icon>
            <span class="app-icon-text__label">{{ 'EDITOR.SHELL.BUTTON.UNDO' | translate }}</span>
          </div>
        </ion-button>

        <ion-button fill="clear" class="tool-btn" [disabled]="!history.canRedo()" (click)="redo()">
          <div class="app-icon-text">
            <ion-icon class="app-icon-text__icon" name="return-up-forward-outline"></ion-icon>
            <span class="app-icon-text__label">{{ 'EDITOR.SHELL.BUTTON.REDO' | translate }}</span>
          </div>
        </ion-button>
      </div>

      <div class="top-toolbox__right">
        @if (showDiscardApply()) {
          <ion-button fill="clear" class="tool-btn" (click)="discardPanel()">
            <div class="app-icon-text">
              <ion-icon class="app-icon-text__icon" name="close-outline"></ion-icon>
              <span class="app-icon-text__label">{{ 'EDITOR.SHELL.BUTTON.DISCARD' | translate }}</span>
            </div>
          </ion-button>

          <ion-button fill="clear" class="tool-btn" [disabled]="!history.isDirty()" (click)="applyPanel()">
            <div class="app-icon-text">
              <ion-icon class="app-icon-text__icon" name="checkmark-outline"></ion-icon>
              <span class="app-icon-text__label">{{ 'EDITOR.SHELL.BUTTON.APPLY' | translate }}</span>
            </div>
          </ion-button>
        }
      </div>
    </div>
  </ion-toolbar>
</ion-header>

<ion-content class="cropper-content shell-bg" [fullscreen]="true" [scrollY]="false">
  <div class="stage">
    <div class="stage-content">
      <div class="stage-bg" [class.stage-bg--checker]="backgroundMode() === 'transparent'"></div>
      <div class="frame-wrap">
        <div
          #frame
          class="frame"
          [class.frame--sampling]="isSampling()"
          [style.--crop-ratio]="aspectRatio"
          (dblclick)="reset()"
          [attr.aria-label]="'EDITOR.SHELL.ARIA.CROP_FRAME' | translate"
        >
        <div class="frame-content" [style.filter]="cssFilter()">
          <div
            class="frame-bg"
            [class.frame-bg--blur]="backgroundMode() === 'blur'"
            [style.backgroundColor]="backgroundMode() === 'color' ? backgroundColor() : null"
            [style.backgroundImage]="backgroundMode() === 'blur' && imageUrl ? 'url(' + imageUrl + ')' : null"
            [style.--bg-blur]="backgroundBlurPx()"
            aria-hidden="true"
          ></div>
          @if (imageUrl) {
            <img
              #img
              class="img"
              [src]="imageUrl"
              alt=""
              draggable="false"
              (load)="onImgLoad($event)"
              (error)="onImgError($event)"
            />
          }
        </div>

          @if (isSampling()) {
            <div
              class="picker-overlay"
              [style.--picker-x]="(pickerPos()?.x ?? 0) + 'px'"
              [style.--picker-y]="(pickerPos()?.y ?? 0) + 'px'"
              [style.--picker-color]="displaySampleHex()"
            [style.--picker-tip-x]="pickerTip().x + 'px'"
            [style.--picker-tip-y]="pickerTip().y + 'px'"
            >
              <div #picker class="color-picker" aria-hidden="true">
                <div class="color-picker__ring"></div>
                <div class="color-picker__center">
                  <ion-icon name="eyedrop-outline"></ion-icon>
                </div>
                <div class="color-picker__crosshair" aria-hidden="true"></div>
              </div>
              @if (showSampleConfirm()) {
                <div class="picker-confirm">
                  <ion-button
                    fill="solid"
                    class="picker-confirm__btn"
                    (click)="confirmSample()"
                    aria-label="Confirm color"
                  >
                    <ion-icon slot="icon-only" name="checkmark-outline"></ion-icon>
                  </ion-button>
                  <ion-button
                    fill="solid"
                    class="picker-confirm__btn"
                    (click)="cancelSample()"
                    aria-label="Keep sampling"
                  >
                    <ion-icon slot="icon-only" name="close-outline"></ion-icon>
                  </ion-button>
                </div>
              }
            </div>
          }

          @if (!ready) {
            <div class="frame-loader" aria-hidden="true">
              <div class="frame-loader__card">
                <ion-spinner name="crescent"></ion-spinner>
                <div class="frame-loader__text">{{ 'EDITOR.SHELL.LABEL.LOADING' | translate }}</div>
              </div>
            </div>
          }
        </div>
      </div>
    </div>
    @if (ready) {
      <div class="hint">{{ hintKey() | translate }}</div>
    }
  </div>

  <!-- Router outlet for tools/adjustments panels -->
  <router-outlet></router-outlet>

    @if (ui.isPanelOpen()) {
    <sh-editor-panel
      [title]="ui.panelTitle() | translate"
      [showReset]="ui.canReset()"
      [showGrabber]="ui.showGrabber()"
      [resetAriaLabel]="'EDITOR.SHELL.ARIA.RESET' | translate"
      [closeAriaLabel]="'EDITOR.SHELL.ARIA.CLOSE' | translate"
      (close)="ui.closePanel()"
      (reset)="onResetPanel()"
    >
      @if (ui.activePanelComponent()) {
        <ng-container *ngComponentOutlet="ui.activePanelComponent(); injector: ui.activePanelInjector()">
        </ng-container>
      } @else {
        <div class="panel-placeholder">
          <p>Panel content: {{ ui.panelId() }}</p>
          <p><small>TODO: Create component for this panel</small></p>
        </div>
      }
    </sh-editor-panel>
  }
</ion-content>
