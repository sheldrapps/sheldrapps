<ion-header>
  <ion-toolbar>
    <ion-title>{{ uiLabels.title }}</ion-title>

    <ion-buttons slot="end">
      <ion-button (click)="cancel()">
        {{ uiLabels.cancelLabel }}
      </ion-button>

      <ion-button [disabled]="!ready" (click)="done()">
        {{ uiLabels.doneLabel }}
      </ion-button>
    </ion-buttons>
  </ion-toolbar>

  <ion-toolbar class="top-toolbox">
    <div class="top-toolbox__row">
      <div class="top-toolbox__center">
        <ion-button 
          fill="clear" 
          class="tool-btn"
          [disabled]="!canUndo"
          (click)="undo()">
          <div class="app-icon-text">
            <ion-icon
              class="app-icon-text__icon"
              name="return-up-back-outline"
            ></ion-icon>
            <span class="app-icon-text__label">{{ uiLabels.undoLabel ?? 'Undo' }}</span>
          </div>
        </ion-button>

        <ion-button 
          fill="clear" 
          class="tool-btn"
          [disabled]="!canRedo"
          (click)="redo()">
          <div class="app-icon-text">
            <ion-icon
              class="app-icon-text__icon"
              name="return-up-forward-outline"
            ></ion-icon>
            <span class="app-icon-text__label">{{ uiLabels.redoLabel ?? 'Redo' }}</span>
          </div>
        </ion-button>
      </div>

      <div class="top-toolbox__right">
        @if (showDiscardApply) {
        <ion-button 
          fill="clear" 
          class="tool-btn"
          (click)="discardBlockSession()">
          <div class="app-icon-text">
            <ion-icon class="app-icon-text__icon" name="close-outline"></ion-icon>
            <span class="app-icon-text__label">{{ uiLabels.discardLabel }}</span>
          </div>
        </ion-button>

        <ion-button 
          fill="clear" 
          class="tool-btn"
          [disabled]="!blockSessionDirty"
          (click)="applyBlockSession()">
          <div class="app-icon-text">
            <ion-icon
              class="app-icon-text__icon"
              name="checkmark-outline"
            ></ion-icon>
            <span class="app-icon-text__label">{{ uiLabels.applyLabel }}</span>
          </div>
        </ion-button>
        }
      </div>
    </div>
  </ion-toolbar>
</ion-header>

<ion-content class="cropper-content" [fullscreen]="true" [scrollY]="false">
  <div class="stage">
    <div class="frame-wrap">
      <div
        #frame
        class="frame"
        [style.--crop-ratio]="aspectRatio"
        (dblclick)="reset()"
        [attr.aria-label]="uiLabels.frameAriaLabel"
      >
        @if (imageUrl) {
        <img
          #img
          class="img"
          [src]="imageUrl"
          alt=""
          draggable="false"
          (load)="onImgLoad($event)"
        />
        }

        <div class="grid" aria-hidden="true"></div>

        @if (!ready) {
        <div class="frame-loader" aria-hidden="true">
          <div class="frame-loader__card">
            <ion-spinner name="crescent"></ion-spinner>
            <div class="frame-loader__text">
              {{ uiLabels.loadingLabel }}
            </div>
          </div>
        </div>
        }
      </div>
    </div>

    @if (ready) {
    <div class="hint">
      {{ uiLabels.hintLabel }}
    </div>
    }
  </div>

  <div
    class="bottom-bar"
    role="toolbar"
    [attr.aria-label]="uiLabels.controlsAriaLabel"
  >
    <ion-button
      fill="clear"
      class="ctrl"
      (click)="zoomOut()"
      [disabled]="scale <= minScale"
      [attr.aria-label]="uiLabels.zoomOutAriaLabel"
    >
      <ion-icon name="remove-outline"></ion-icon>
    </ion-button>

    <ion-button
      fill="clear"
      class="ctrl"
      (click)="reset()"
      [attr.aria-label]="uiLabels.resetAriaLabel"
    >
      <ion-icon name="refresh-outline"></ion-icon>
    </ion-button>

    <ion-button
      fill="clear"
      class="ctrl"
      (click)="zoomIn()"
      [disabled]="scale >= maxScale"
      [attr.aria-label]="uiLabels.zoomInAriaLabel"
    >
      <ion-icon name="add-outline"></ion-icon>
    </ion-button>

    <ion-button
      class="adjust-btn"
      (click)="toggleAdjustments()"
      [disabled]="!ready"
    >
      {{ uiLabels.adjustmentsLabel }}
      <ion-icon
        class="adjust-btn__icon"
        [name]="adjustOpen ? 'close-outline' : 'chevron-up-outline'"
      ></ion-icon>
    </ion-button>

    <div class="spacer"></div>
  </div>

  @if (adjustOpen) {
  <div
    class="sheet"
    role="dialog"
    [attr.aria-label]="uiLabels.adjustmentsAriaLabel"
  >
    <div class="sheet-head">
      <ion-button fill="clear" class="sheet-reset" (click)="resetAdjustments()" [attr.aria-label]="uiLabels.resetAdjustmentsAriaLabel">
        <ion-icon slot="icon-only" name="refresh-outline"></ion-icon>
      </ion-button>

      <div class="sheet-grabber" aria-hidden="true"></div>

      <div class="sheet-title">
        {{ uiLabels.adjustmentsLabel }}
      </div>

      <ion-button fill="clear" class="sheet-close" (click)="closeAdjustments()">
        <ion-icon name="close-outline"></ion-icon>
      </ion-button>
    </div>

    <div class="sheet-body">
      <div class="tools-bar adjustments-tools">
        <div class="tools-group tools-group--scrollable">
          <div class="tools-buttons" #adjustTabsContainer>
            <ion-button
              fill="clear"
              class="tool-btn"
              [class.tool-btn--active]="activeAdjustPanel === 'brightness'"
              (click)="setAdjustPanel('brightness')"
            >
              <span>{{ uiLabels.brightnessLabel }}</span>
            </ion-button>

            <ion-button
              fill="clear"
              class="tool-btn"
              [class.tool-btn--active]="activeAdjustPanel === 'saturation'"
              (click)="setAdjustPanel('saturation')"
            >
              <span>{{ uiLabels.saturationLabel }}</span>
            </ion-button>

            <ion-button
              fill="clear"
              class="tool-btn"
              [class.tool-btn--active]="activeAdjustPanel === 'contrast'"
              (click)="setAdjustPanel('contrast')"
            >
              <span>{{ uiLabels.contrastLabel }}</span>
            </ion-button>

            <ion-button
              fill="clear"
              class="tool-btn"
              [class.tool-btn--active]="activeAdjustPanel === 'bw'"
              (click)="setAdjustPanel('bw')"
            >
              <span>{{ uiLabels.bwLabel }}</span>
            </ion-button>
          </div>

          @if (showFadeLeft) {
          <div class="tabs-fade-left"></div>
          }

          @if (showFadeRight) {
          <div class="tabs-fade-right"></div>
          }
        </div>
      </div>

      @if (activeAdjustPanel === 'brightness') {
      <ion-item lines="none">
        <ion-label>{{ uiLabels.brightnessLabel }}</ion-label>
        <ion-range
          [min]="0.5"
          [max]="1.5"
          [step]="0.01"
          [(ngModel)]="brightness"
          (ionStart)="onSliderStart()"
          (ionInput)="onAdjustChanged()"
          (ionSliderDidChange)="onSliderEnd()"
        ></ion-range>
      </ion-item>
      }

      @if (activeAdjustPanel === 'saturation') {
      <ion-item lines="none">
        <ion-label>{{ uiLabels.saturationLabel }}</ion-label>
        <ion-range
          [min]="0"
          [max]="2"
          [step]="0.01"
          [(ngModel)]="saturation"
          (ionStart)="onSliderStart()"
          (ionInput)="onAdjustChanged()"
          (ionSliderDidChange)="onSliderEnd()"
          [disabled]="bw"
        ></ion-range>
      </ion-item>
      }

      @if (activeAdjustPanel === 'contrast') {
      <ion-item lines="none">
        <ion-label>{{ uiLabels.contrastLabel }}</ion-label>
        <ion-range
          [min]="0.5"
          [max]="1.8"
          [step]="0.01"
          [(ngModel)]="contrast"
          (ionStart)="onSliderStart()"
          (ionInput)="onAdjustChanged()"
          (ionSliderDidChange)="onSliderEnd()"
        ></ion-range>
      </ion-item>
      }

      @if (activeAdjustPanel === 'bw') {
      <ion-item lines="none" class="toggles">
        <ion-label>{{ uiLabels.bwLabel }}</ion-label>
        <ion-toggle [(ngModel)]="bw" (ionChange)="onAdjustChanged()"></ion-toggle>

        <div class="row-spacer"></div>

        <ion-label class="dither-label" [class.disabled]="!bw">
          {{ uiLabels.ditherLabel }}
        </ion-label>
        <ion-toggle
          [(ngModel)]="dither"
          (ionChange)="onAdjustChanged()"
          [disabled]="!bw"
        ></ion-toggle>
      </ion-item>
      }
    </div>
  </div>
  }
</ion-content>
