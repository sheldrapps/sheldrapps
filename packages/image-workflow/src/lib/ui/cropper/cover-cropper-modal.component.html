<ion-header>
  <ion-toolbar>
    <ion-title>{{ title }}</ion-title>

    <ion-buttons slot="end">
      <ion-button (click)="cancel()">
        {{ cancelLabel }}
      </ion-button>

      <ion-button [disabled]="!ready" (click)="use()">
        {{ doneLabel }}
      </ion-button>
    </ion-buttons>
  </ion-toolbar>

  <ion-toolbar class="top-toolbox">
    <div class="top-toolbox__row">
      <div class="top-toolbox__center">
        <ion-button fill="clear" class="tool-btn">
          <div class="app-icon-text">
            <ion-icon
              class="app-icon-text__icon"
              name="return-up-back-outline"
            ></ion-icon>
            <span class="app-icon-text__label">Deshacer</span>
          </div>
        </ion-button>

        <ion-button fill="clear" class="tool-btn">
          <div class="app-icon-text">
            <ion-icon
              class="app-icon-text__icon"
              name="return-up-forward-outline"
            ></ion-icon>
            <span class="app-icon-text__label">Rehacer</span>
          </div>
        </ion-button>
      </div>

      <div class="top-toolbox__right">
        <ion-button fill="clear" class="tool-btn">
          <div class="app-icon-text">
            <ion-icon class="app-icon-text__icon" name="close-outline"></ion-icon>
            <span class="app-icon-text__label">Descartar</span>
          </div>
        </ion-button>

        <ion-button fill="clear" class="tool-btn">
          <div class="app-icon-text">
            <ion-icon
              class="app-icon-text__icon"
              name="checkmark-outline"
            ></ion-icon>
            <span class="app-icon-text__label">{{ doneLabel }}</span>
          </div>
        </ion-button>
      </div>
    </div>
  </ion-toolbar>
</ion-header>

<ion-content class="cropper-content" [fullscreen]="true" [scrollY]="false">
  <div class="stage">
    <div class="frame-wrap">
      <div
        #frame
        class="frame"
        [style.--crop-ratio]="aspectRatio"
        (dblclick)="reset()"
        [attr.aria-label]="'CROPPER.FRAME_ARIA' | translate"
      >
        @if (imageUrl) {
        <img
          #img
          class="img"
          [src]="imageUrl"
          alt=""
          draggable="false"
          (load)="onImgLoad($event)"
        />
        }

        <div class="grid" aria-hidden="true"></div>

        @if (!ready) {
        <div class="frame-loader" aria-hidden="true">
          <div class="frame-loader__card">
            <ion-spinner name="crescent"></ion-spinner>
            <div class="frame-loader__text">
              {{ "COMMON.LOADING" | translate }}
            </div>
          </div>
        </div>
        }
      </div>
    </div>

    @if (ready) {
    <div class="hint">
      {{ "CROPPER.HINT" | translate }}
    </div>
    }
  </div>

  <div
    class="bottom-bar"
    role="toolbar"
    [attr.aria-label]="'CROPPER.CONTROLS_ARIA' | translate"
  >
    <ion-button
      fill="clear"
      class="ctrl"
      (click)="zoomOut()"
      [disabled]="scale <= minScale"
      [attr.aria-label]="'CROPPER.ZOOM_OUT_ARIA' | translate"
    >
      <ion-icon name="remove-outline"></ion-icon>
    </ion-button>

    <ion-button
      fill="clear"
      class="ctrl"
      (click)="reset()"
      [attr.aria-label]="'CROPPER.RESET_ARIA' | translate"
    >
      <ion-icon name="refresh-outline"></ion-icon>
    </ion-button>

    <ion-button
      fill="clear"
      class="ctrl"
      (click)="zoomIn()"
      [disabled]="scale >= maxScale"
      [attr.aria-label]="'CROPPER.ZOOM_IN_ARIA' | translate"
    >
      <ion-icon name="add-outline"></ion-icon>
    </ion-button>

    <ion-button
      class="adjust-btn"
      (click)="toggleAdjustments()"
      [disabled]="!ready"
    >
      {{ "CROPPER.ADJUSTMENTS" | translate }}
      <ion-icon
        class="adjust-btn__icon"
        [name]="adjustOpen ? 'close-outline' : 'chevron-up-outline'"
      ></ion-icon>
    </ion-button>

    <div class="spacer"></div>
  </div>

  @if (adjustOpen) {
  <div
    class="sheet"
    role="dialog"
    [attr.aria-label]="'CROPPER.ADJUSTMENTS_ARIA' | translate"
  >
    <div class="sheet-head">
      <ion-button fill="clear" class="sheet-reset" (click)="resetAdjustments()" [attr.aria-label]="'CROPPER.RESET_ADJUSTMENTS_ARIA' | translate">
        <ion-icon slot="icon-only" name="refresh-outline"></ion-icon>
      </ion-button>

      <div class="sheet-grabber" aria-hidden="true"></div>

      <div class="sheet-title">
        {{ "CROPPER.ADJUSTMENTS" | translate }}
      </div>

      <ion-button fill="clear" class="sheet-close" (click)="closeAdjustments()">
        <ion-icon name="close-outline"></ion-icon>
      </ion-button>
    </div>

    <div class="sheet-body">
      <div class="tools-bar adjustments-tools">
        <div class="tools-group">
          <div class="tools-buttons">
            <ion-button
              fill="clear"
              class="tool-btn"
              [class.tool-btn--active]="activeAdjustPanel === 'brightness'"
              (click)="setAdjustPanel('brightness')"
            >
              <span>{{ "CROPPER.BRIGHTNESS" | translate }}</span>
            </ion-button>

            <ion-button
              fill="clear"
              class="tool-btn"
              [class.tool-btn--active]="activeAdjustPanel === 'saturation'"
              (click)="setAdjustPanel('saturation')"
            >
              <span>{{ "CROPPER.SATURATION" | translate }}</span>
            </ion-button>

            <ion-button
              fill="clear"
              class="tool-btn"
              [class.tool-btn--active]="activeAdjustPanel === 'contrast'"
              (click)="setAdjustPanel('contrast')"
            >
              <span>{{ "CROPPER.CONTRAST" | translate }}</span>
            </ion-button>

            <ion-button
              fill="clear"
              class="tool-btn"
              [class.tool-btn--active]="activeAdjustPanel === 'bw'"
              (click)="setAdjustPanel('bw')"
            >
              <span>{{ "CROPPER.BW" | translate }}</span>
            </ion-button>
          </div>
        </div>
      </div>

      @if (activeAdjustPanel === 'brightness') {
      <ion-item lines="none">
        <ion-label>{{ "CROPPER.BRIGHTNESS" | translate }}</ion-label>
        <ion-range
          [min]="0.5"
          [max]="1.5"
          [step]="0.01"
          [(ngModel)]="brightness"
          (ionInput)="onAdjustChanged()"
        ></ion-range>
      </ion-item>
      }

      @if (activeAdjustPanel === 'saturation') {
      <ion-item lines="none">
        <ion-label>{{ "CROPPER.SATURATION" | translate }}</ion-label>
        <ion-range
          [min]="0"
          [max]="2"
          [step]="0.01"
          [(ngModel)]="saturation"
          (ionInput)="onAdjustChanged()"
          [disabled]="bw"
        ></ion-range>
      </ion-item>
      }

      @if (activeAdjustPanel === 'contrast') {
      <ion-item lines="none">
        <ion-label>{{ "CROPPER.CONTRAST" | translate }}</ion-label>
        <ion-range
          [min]="0.5"
          [max]="1.8"
          [step]="0.01"
          [(ngModel)]="contrast"
          (ionInput)="onAdjustChanged()"
        ></ion-range>
      </ion-item>
      }

      @if (activeAdjustPanel === 'bw') {
      <ion-item lines="none" class="toggles">
        <ion-label>{{ "CROPPER.BW" | translate }}</ion-label>
        <ion-toggle [(ngModel)]="bw" (ionChange)="onAdjustChanged()"></ion-toggle>

        <div class="row-spacer"></div>

        <ion-label class="dither-label" [class.disabled]="!bw">
          {{ "CROPPER.DITHER" | translate }}
        </ion-label>
        <ion-toggle
          [(ngModel)]="dither"
          (ionChange)="onAdjustChanged()"
          [disabled]="!bw"
        ></ion-toggle>
      </ion-item>
      }
    </div>
  </div>
  }
</ion-content>
