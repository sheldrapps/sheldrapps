<ion-header>
  <ion-toolbar>
    <ion-buttons slot="start">
      <ion-back-button defaultHref="/tabs/change"></ion-back-button>
    </ion-buttons>
    <ion-title>{{ 'COVERS.TITLE' | translate }}</ion-title>
  </ion-toolbar>
</ion-header>

<ion-content
  class="ion-padding"
  [scrollEvents]="true"
  (ionScrollStart)="onScrollStart()"
  (ionScrollEnd)="onScrollEnd()"
>
  @if (pageErrorKey) {
  <div class="app-callout app-callout--error" aria-live="polite" role="status">
    <ion-icon
      class="app-callout__icon"
      name="close-circle-outline"
      aria-hidden="true"
    ></ion-icon>
    <div>
      <div class="app-callout__title">{{ 'COMMON.ERROR' | translate }}</div>
      <div class="app-callout__body">
        {{ pageErrorKey | translate:pageErrorParams }}
      </div>
    </div>
  </div>
  }

  <ion-refresher slot="fixed" (ionRefresh)="load($event)">
    <ion-refresher-content></ion-refresher-content>
  </ion-refresher>

  @if (loading) {
  <div class="loading">
    <ion-spinner></ion-spinner>
  </div>
  } @else {
  <ion-grid>
    <ion-row>
      @for (item of items; track trackByFilename($index, item)) {
      <ion-col size="6" size-md="4">
        <ion-card
          class="cover-card"
          (pointerdown)="onPressStart($event, item.filename)"
          (pointermove)="onPressMove($event)"
          (pointerup)="onPressEnd($event, item.filename)"
          (pointercancel)="onPressCancel()"
          (pointerleave)="onPressCancel()"
        >
          @if (item.thumbDataUrl) {
          <img class="thumb" [src]="item.thumbDataUrl" alt="epub cover" />
          } @else {
          <div class="thumb placeholder">
            {{ 'COVERS.PLACEHOLDER' | translate }}
          </div>
          }
          <div class="file-name" [title]="getDisplayName(item.filename)">
            {{ getDisplayName(item.filename) }}
          </div>

          <ion-button
            class="dots"
            fill="clear"
            size="small"
            (pointerdown)="$event.stopPropagation()"
            (pointerup)="$event.stopPropagation()"
            (pointercancel)="$event.stopPropagation()"
            (click)="$event.stopPropagation(); showMenu($event, item.filename)"
          >
            <ion-icon name="ellipsis-vertical"></ion-icon>
          </ion-button>
        </ion-card>
      </ion-col>
      } @if (items.length === 0) {
      <ion-col size="12">
        <div class="empty">{{ 'COVERS.EMPTY' | translate }}</div>
      </ion-col>
      }
    </ion-row>
  </ion-grid>
  }

  <ion-popover
    [isOpen]="openPopover"
    [event]="popoverEvent"
    (didDismiss)="openPopover = false"
  >
    <ng-template>
      <ion-list lines="none">
        <ion-item button (click)="shareActive()">
          <ion-icon slot="start" name="share-outline"></ion-icon>
          <ion-label>{{ 'COVERS.ACTIONS.SHARE' | translate }}</ion-label>
        </ion-item>
        <ion-item button (click)="deleteActive()">
          <ion-icon slot="start" name="trash-outline"></ion-icon>
          <ion-label>{{ 'COVERS.ACTIONS.DELETE' | translate }}</ion-label>
        </ion-item>
      </ion-list>
    </ng-template>
  </ion-popover>

  <ion-modal
    [isOpen]="previewOpen"
    (didDismiss)="closePreview()"
    class="cover-preview-modal"
  >
    <ng-template>
      <ion-header>
        <ion-toolbar class="preview-toolbar">
          <ion-buttons slot="start">
            <ion-button
              fill="clear"
              size="small"
              (click)="toggleInfo($event)"
              aria-label="{{ 'CHANGE.INFO_ARIA' | translate }}"
            >
              <ion-icon slot="icon-only" name="information-circle-outline"></ion-icon>
            </ion-button>
          </ion-buttons>

          <ion-title class="preview-title">{{ 'COVERS.PREVIEW_TITLE' | translate }}</ion-title>

          <ion-buttons slot="end">
            <ion-button class="preview-cancel" (click)="closePreview()">
              {{ 'COMMON.CLOSE' | translate }}
            </ion-button>
          </ion-buttons>
        </ion-toolbar>
      </ion-header>

      <ion-content
        class="preview-content"
        [fullscreen]="true"
        [scrollY]="false"
      >
        <div class="stage">
          <div class="frame-wrap">
            <div class="frame">
              @if (previewDataUrl) {
              <img class="preview-img" [src]="previewDataUrl" alt="cover preview" />
              } @if (previewLoading) {
              <div class="frame-loader" aria-hidden="true">
                <div class="frame-loader__card">
                  <ion-spinner name="crescent"></ion-spinner>
                  <div class="frame-loader__text">
                    {{ 'COMMON.LOADING' | translate }}
                  </div>
                </div>
              </div>
              }
            </div>
          </div>
        </div>

        <div class="bottom-bar" role="toolbar">
          <div class="bottom-inner">
            <ion-button
              fill="clear"
              class="ctrl"
              (click)="sharePreview()"
              [disabled]="previewLoading || !previewFilename"
            >
              <ion-icon name="share-outline"></ion-icon>
              <span class="ctrl-text">{{ 'COMMON.SHARE' | translate }}</span>
            </ion-button>

            <ion-button
              fill="clear"
              class="ctrl"
              (click)="deletePreview()"
              [disabled]="previewLoading || !previewFilename"
            >
              <ion-icon name="trash-outline"></ion-icon>
              <span class="ctrl-text">{{ 'COMMON.DELETE' | translate }}</span>
            </ion-button>
          </div>
        </div>
      </ion-content>

      <ion-popover
        [isOpen]="infoOpen"
        [event]="infoEvent"
        (didDismiss)="closeInfo()"
        side="bottom"
        alignment="start"
      >
        <ng-template>
          <div class="preview-info-popover">
            <div class="preview-info-title">{{ 'CHANGE.INFO_TITLE' | translate }}</div>
            <div class="preview-info-body">
              {{ 'COMMON.SHARE_KINDLE_HINT' | translate }}
            </div>
          </div>
        </ng-template>
      </ion-popover>
    </ng-template>
  </ion-modal>
</ion-content>
